

---

## POST /chat/stream — 智能问答流式接口

### 1. 基本信息

| 项目 | 说明 |
|------|------|
| **URL** | `POST /api/chat/stream`（或你配置的 `VITE_API_BASE_URL` + `/chat/stream`，例如 `POST /api/chat/stream`） |
| **方法** | `POST` |
| **Content-Type** | `application/json` |
| **鉴权** | Header：`Authorization: Bearer <token>`（前端取 localStorage 的 `student_token`） |

---

### 2. 请求体（JSON）

```json
{
  "messages": [
    { "role": "user", "content": "用户第1条消息" },
    { "role": "assistant", "content": "助手第1条回复" },
    { "role": "user", "content": "用户第2条消息" }
  ],
  "options": {
    "model": "gpt-4o-mini",
    "knowledgeBaseIds": ["doc-id-1", "doc-id-2"],
    "skills": ["code", "math"],
    "systemPrompt": "你是一位教学助手，请用简洁易懂的语言回答。"
  }
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **messages** | `array` | 是 | 当前会话的多轮消息，按时间顺序。 |
| **messages[].role** | `string` | 是 | `"user"` 或 `"assistant"`。 |
| **messages[].content** | `string` | 是 | 该条消息的纯文本内容。 |
| **options** | `object` | 否 | 不传或传空对象时前端也可能不带该字段。 |
| **options.model** | `string` | 否 | 模型标识，如 `gpt-4o`、`gpt-4o-mini`。 |
| **options.knowledgeBaseIds** | `string[]` | 否 | 知识库/文档 id 列表，用于 RAG 检索。 |
| **options.skills** | `string[]` | 否 | 启用的 skill 标识列表。 |
| **options.systemPrompt** | `string` | 否 | 系统提示词，约束角色或风格。 |

---

### 3. 响应（流式 + 末尾一行元数据）

- **成功**：HTTP 状态码 `200`，Body 为**流式文本**。
- **约定**：
  - 前面所有内容：**逐字/逐段**输出的回答正文（纯文本，UTF-8）。
  - **最后一行**：单独一行 JSON，作为**调试元数据**（见下），前面要有换行；前端会从正文中剥离该行，只用于调试展示。

#### 3.1 正文部分（流式）

- 普通流式文本，无固定格式；前端用 `ReadableStream` 按 chunk 读取并拼接显示。
- 示例（实际流中不会带注释）：
  ```
  这是回答的第一段。
  这是第二段……
  ```

#### 3.2 最后一行：调试元数据（JSON）

- 必须是**完整一行** JSON，且至少包含下列字段之一，前端才识别为元数据并做解析：
  - `usage`
  - `conversationId`
  - `skillsUsed`
  - `recall`
- 建议结构（后端可增删字段，前端会原样展示在调试里）：

```json
{
  "usage": {
    "inputTokens": 100,
    "outputTokens": 200,
    "totalTokens": 300
  },
  "conversationId": "conv-xxx",
  "skillsUsed": ["code", "math"],
  "recall": [
    { "docId": "doc1", "content": "召回片段内容…", "score": 0.92 },
    { "docId": "doc2", "content": "另一段…", "score": 0.88 }
  ]
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| **usage** | `object` | Token 使用量。 |
| **usage.inputTokens** | `number` | 输入 token 数。 |
| **usage.outputTokens** | `number` | 输出 token 数。 |
| **usage.totalTokens** | `number` | 总 token 数。 |
| **conversationId** | `string` | 对话/会话 id。 |
| **skillsUsed** | `string[]` | 实际用到的 skill 列表。 |
| **recall** | `array` | RAG 召回结果。 |
| **recall[].docId** | `string` | 文档 id。 |
| **recall[].content** | `string` | 片段内容。 |
| **recall[].score** | `number` | 相关度/分数。 |

- 若**不**带上述任一字段，该行不会被当作元数据，会保留在回答正文中。

#### 3.3 完整响应示例（概念）

```
这是模型的回答正文，可以多段流式输出。

{"usage":{"inputTokens":50,"outputTokens":120,"totalTokens":170},"conversationId":"conv-abc","skillsUsed":["code"],"recall":[{"docId":"kb1","content":"...","score":0.9}]}
```

---

### 4. 错误响应

- **HTTP 状态码**：非 2xx（如 400、401、500）。
- **Body**：建议 JSON，便于前端统一提示：

```json
{
  "message": "错误说明文案"
}
```

- 前端会读取 `message` 并提示给用户；若不是 JSON，则用响应 body 文本作为错误信息。

---

### 5. 小结给后端

| 项目 | 说明 |
|------|------|
| **路径** | `POST /api/chat/stream` |
| **鉴权** | `Authorization: Bearer <token>` |
| **请求** | JSON：`messages`（必填）+ `options`（可选，含 model、knowledgeBaseIds、skills、systemPrompt） |
| **成功响应** | 200 + 流式文本；**最后一行**为一条 JSON（含 usage/conversationId/skillsUsed/recall 等），前端当调试元数据，不显示在气泡内 |
| **失败响应** | 非 2xx + JSON `{ "message": "错误说明" }` |

按上述实现即可与当前前端智能问答和调试面板（含 token 使用量、对话 id、使用的 skills、召回信息等）对齐。