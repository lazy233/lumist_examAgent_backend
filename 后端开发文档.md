# LUMIST 学生端 - 后端开发文档

本文档根据前端功能归纳后端需实现的模块与接口，供后端开发对接。

## 0. 方案与实施步骤

目标：面向学生用户，支持上传文件或输入描述，并结合本地文档库生成练习题；与前端约定接口保持一致。

### 0.1 总体方案

- 架构：FastAPI API 层 + LangChain 文档/LLM 处理层 + PostgreSQL 业务数据 + Redis 缓存 + 本地文件系统存储原始文件与解析结果。
- 可维护性要求：模块职责清晰、分层结构固定、配置集中管理、接口与模型有明确边界；后续实现需优先保证可读性与可扩展性。
- 生成流程：
  - 文件上传 -> 解析入库 -> 构建向量索引/检索 -> 题目生成
  - 文字描述 -> 关键要点分析 -> 题目生成（流式/异步）
- 本地文档库：以项目内 `data/library/` 为根目录统一管理，文件元数据入库，支持按用户维度检索与出题。

### 0.2 实施步骤（按顺序执行，含：用什么/怎么做/实现目标）

1. **项目骨架与依赖**
   - 用什么：FastAPI、Pydantic、SQLAlchemy、LangChain、Redis、PostgreSQL、python-multipart。
   - 怎么做：创建 `app/`（`api/`, `services/`, `repositories/`, `models/`, `schemas/`, `core/`），准备配置加载与启动入口。
   - 实现目标：有可启动的 API 骨架与依赖环境。
2. **数据库与数据模型**
   - 用什么：PostgreSQL（仅存结构化数据）+ SQLAlchemy；向量库使用 Qdrant（存知识库向量与片段内容）。
   - 怎么做：建表 `users`, `docs`, `exercises`, `questions`, `answers`, `exercise_results`，统一 `created_at/updated_at/status/owner_id`；文档分块向量与片段内容写入 Qdrant（payload 含 `docId/ownerId/chunkIndex/content`）。
   - SQL 保存：`sql/schema.sql`（只包含结构化表）。
   - 实现目标：结构化数据入 PG；知识库向量入向量数据库。
3. **文件存储与本地文档库**
   - 用什么：本地文件系统，目录 `data/upload/` 与 `data/library/`。
   - 怎么做：上传文件保存到 `upload/`；用户勾选保存时复制到 `library/`；记录文件元数据与路径。
   - 实现目标：文件可追溯、可复用、与用户资料库关联。
4. **文档解析与切片**
   - 用什么：LangChain 文档加载器（pdf/docx/pptx/txt）+ 自定义清洗。
   - 怎么做：解析文本 -> 分段切片 -> 保存到 `doc_chunks`；同步更新 `docs.status`。
   - 实现目标：文档内容可被检索与出题使用。
5. **向量化与检索**
   - 用什么：Embedding 模型 + 向量索引（本地/数据库均可）。
   - 怎么做：为 `doc_chunks` 建向量；按 `docId/ownerId` 检索最相关片段。
   - 实现目标：出题可基于本地文档进行准确检索。
6. **出题引擎（文本/文档）**
   - 用什么：LLM + 统一提示词模板（题型/难度/数量）。
   - 怎么做：文字材料先 `analyze` 得到关键要点；确认后流式生成题目；文档出题走检索 -> 生成。
   - 实现目标：返回符合题型和难度的题目内容。
7. **接口实现（对齐本文档）**
   - 用什么：FastAPI 路由 + 依赖注入。
   - 怎么做：实现 Auth/Docs/Exercises 全部接口；SSE 与流式响应按约定格式输出。
   - 实现目标：前端能完整对接并正常交互。
8. **异步任务与缓存**
   - 用什么：后台任务（线程池/队列）+ Redis。
   - 怎么做：解析与生成走异步；缓存常用题目与会话上下文。
   - 实现目标：长耗时任务不阻塞，响应稳定。
9. **测试与验收**
   - 用什么：接口测试工具（Postman/HTTPie）。
   - 怎么做：覆盖上传、解析、流式生成、提交答案与评分。
   - 实现目标：所有接口满足本文档的请求/响应约定。
10. **部署与运维**
   - 用什么：环境变量 + 日志 + 定时清理脚本。
   - 怎么做：配置数据库/Redis/LLM key；设置日志与清理策略。
   - 实现目标：可在目标环境稳定运行。

### 0.3 里程碑交付

- M1：完成认证与文档上传/解析链路（含 SSE）。
- M2：完成文字材料出题（含流式输出）。
- M3：完成按文档出题、练习提交与结果评分。

后端：

- Python + FastAPI（处理API请求）
- LangChain（处理文档和LLM调用）
- PostgreSQL（存储用户、题目、文件元数据）
- Redis（缓存常用题目和会话）
- 本地文件系统（文件存储）

---

## 一、通用约定

### 1.1 基础与鉴权

- **Base URL**：前端通过环境变量 `VITE_API_BASE_URL` 配置，默认 `/api`。所有接口均以此为前缀（如 `/api/auth/login`）。
- **鉴权方式**：除登录接口外，请求头需携带 `Authorization: Bearer <token>`。Token 由登录接口返回，前端持久化后每次请求自动带上。
- **401 处理**：后端返回 401 时，前端会清除本地 token 并跳转登录；错误体建议包含 `message` 供前端提示。

### 1.2 错误响应格式

- 建议统一结构：`{ "message": "错误描述" }`。前端会将 `message` 用于 ElMessage 提示。
- HTTP 状态码：4xx/5xx 表示失败；业务错误也可用 200 + 业务 code，由前端按约定解析。

### 1.3 分页

- 列表类接口统一使用 `page`、`pageSize` 查询参数（从 1 开始或从 0 开始需统一约定）。
- 响应建议包含 `items`（数组）和 `total`（总数）。

---

## 二、认证模块（Auth）

### 2.1 登录

- **接口**：`POST /auth/login`
- **鉴权**：不需要
- **请求体**：
  ```json
  { "username": "string", "password": "string" }
  ```
- **成功响应**：
  ```json
  {
    "token": "string",
    "user": { "id": "string", "name": "string" }
  }
  ```
- **说明**：前端仅使用 `user.id`、`user.name`；token 用于后续所有需鉴权接口。

---

## 三、资料模块（Docs）

### 3.1 上传文档

- **接口**：`POST /docs/upload`
- **Content-Type**：`multipart/form-data`
- **表单字段**：
  - `file`：必填，文件本体（支持 pdf / docx / pptx / txt，前端已做校验）
  - `saveToLibrary`：可选，`"true"` / `"false"`，是否存入用户资料库
- **成功响应**：
  ```json
  { "docId": "string", "fileName": "string", "status": "uploaded" }
  ```

### 3.2 发起解析

- **接口**：`POST /docs/:docId/parse`
- **成功响应**：
  ```json
  { "docId": "string", "status": "uploaded" | "parsing" | "done" | "failed" }
  ```
- **说明**：触发异步解析；解析进度/结果通过详情接口或 SSE 流获取。

### 3.3 文档详情

- **接口**：`GET /docs/:docId`
- **成功响应**：
  ```json
  {
    "docId": "string",
    "fileName": "string",
    "status": "uploaded" | "parsing" | "done" | "failed",
    "parsed": {
      "school": "string",
      "major": "string",
      "course": "string",
      "knowledgePoints": ["string"],
      "summary": "string"
    },
    "createdAt": "string"
  }
  ```
- **说明**：`parsed` 仅在 `status === "done"` 时存在且有意义；`createdAt` 建议 ISO 8601。

### 3.4 文档列表（我的资料）

- **接口**：`GET /docs`
- **查询参数**：`keyword`（可选）、`page`、`pageSize`
- **成功响应**：
  ```json
  {
    "items": [ /* 元素结构同 3.3 文档详情 */ ],
    "total": 0
  }
  ```

### 3.5 删除文档

- **接口**：`DELETE /docs/:docId`
- **成功**：204 或 200 无体均可；前端只关心成功/失败。

### 3.6 解析进度流（SSE）

- **接口**：`GET /docs/:docId/parse/stream`
- **说明**：前端使用 `EventSource` 订阅，用于文档详情页「解析中」的实时展示。浏览器 EventSource 无法自定义 Header，若需鉴权可考虑 URL 参数（如 `?token=xxx`）。
- **事件类型与 payload**：
  - **field**：`{ "name": "school"|"major"|"course"|"summary", "delta": "string" }` — 增量文本，前端按字段累加展示。
  - **knowledge_point**：`{ "delta": "string" }` — 单个知识点增量，前端追加到知识点列表。
  - **done**：`{ "status": "done"|"failed" }` — 解析结束；前端停止流并更新状态。
  - **error**：`{ "message": "string" }` — 解析失败原因；前端展示并置为 failed。

---

## 四、练习/出题模块（Exercises）

### 4.1 根据文字材料分析（出题中心 - 确认前）

- **接口**：`POST /exercises/analyze`
- **请求体**：
  ```json
  {
    "content": "string",
    "questionType": "string",
    "difficulty": "string",
    "count": 0
  }
  ```
- **说明**：`questionType` 与前端题型 value 一致（如 `single_choice`、`multiple_choice`、`true_false`、`fill_blank`、`short_answer`）；`difficulty` 为 `easy`/`medium`/`hard`。
- **成功响应**：
  ```json
  { "keyPoints": ["string"] }
  ```
- **说明**：大模型根据材料生成的「确认要点」，前端在确认弹窗中逐条展示；条数、内容由后端决定。

### 4.2 根据文字材料流式生成题目（出题中心 - 确认后）

- **接口**：`POST /exercises/generate-from-text`
- **请求体**：同 4.1（`content`、`questionType`、`difficulty`、`count`）。
- **响应**：`Transfer-Encoding: chunked` 的**纯文本流**。内容为题目正文（如 Markdown 或纯文本），前端边收边展示；流结束后可在**最后一行**追加一行 JSON，供前端解析 `exerciseId`：
  ```text
  ...题目正文...
  {"exerciseId":"xxx"}
  ```
- **说明**：若最后一行能解析为 `{ "exerciseId": "string" }`，前端会用于「查看全部题目」跳转至该练习详情；否则跳转练习列表。流式过程中前端仅展示前 N 字（如 800），完成后展示全文。

### 4.3 根据文档生成题目（资料详情页）

- **接口**：`POST /exercises/generate`
- **请求体**：
  ```json
  {
    "docId": "string",
    "types": ["single_choice", "fill_blank", "short_answer"],
    "difficulty": "easy" | "medium" | "hard",
    "count": 0
  }
  ```
- **成功响应**：
  ```json
  { "exerciseId": "string", "status": "generating" }
  ```
- **说明**：异步生成；前端轮询 4.5 练习详情，根据 `status` 为 `ready` / `failed` 决定跳转或提示失败。

### 4.4 练习详情

- **接口**：`GET /exercises/:exerciseId`
- **成功响应**：
  ```json
  {
    "exerciseId": "string",
    "title": "string",
    "status": "generating" | "ready" | "failed",
    "difficulty": "easy" | "medium" | "hard",
    "count": 0,
    "questions": [
      {
        "questionId": "string",
        "type": "single_choice" | "multiple_choice" | "true_false" | "fill_blank" | "short_answer",
        "stem": "string",
        "options": { "A": "string", "B": "string", ... }
      }
    ],
    "createdAt": "string",
    "score": 0
  }
  ```
- **说明**：`options` 仅选择题有；简答题/填空题为空或省略。`score` 为提交后才有；未提交时可不返回或为 null。

### 4.5 提交答案

- **接口**：`POST /exercises/:exerciseId/submit`
- **请求体**：
  ```json
  { "answers": [ { "questionId": "string", "answer": "string" } ] }
  ```
- **成功响应**：
  ```json
  {
    "score": 0,
    "correctRate": 0,
    "results": [
      {
        "questionId": "string",
        "isCorrect": true,
        "userAnswer": "string",
        "correctAnswer": "string",
        "analysis": "string"
      }
    ]
  }
  ```

### 4.6 练习列表（我的练习）

- **接口**：`GET /exercises`
- **查询参数**：`keyword`、`difficulty`、`page`、`pageSize`
- **成功响应**：
  ```json
  {
    "items": [
      {
        "exerciseId": "string",
        "title": "string",
        "count": 0,
        "difficulty": "easy" | "medium" | "hard",
        "score": 0,
        "createdAt": "string",
        "status": "generating" | "ready" | "failed"
      }
    ],
    "total": 0
  }
  ```

---

## 五、未对接或占位功能

- **个人中心**：当前「保存资料」「修改密码」仅前端占位，未调用后端；若后续需要，可补充 `PATCH /user/profile`、`POST /auth/change-password` 等接口并在本文档中扩展。

---

## 六、模块与接口总览

| 模块   | 方法   | 路径                              | 说明                     |
|--------|--------|-----------------------------------|--------------------------|
| 认证   | POST   | `/auth/login`                     | 登录，返回 token + user  |
| 资料   | POST   | `/docs/upload`                    | 上传文档                 |
| 资料   | POST   | `/docs/:docId/parse`              | 发起解析                 |
| 资料   | GET    | `/docs/:docId`                    | 文档详情                 |
| 资料   | GET    | `/docs`                           | 文档列表                 |
| 资料   | DELETE | `/docs/:docId`                    | 删除文档                 |
| 资料   | GET    | `/docs/:docId/parse/stream`       | 解析进度 SSE 流          |
| 练习   | POST   | `/exercises/analyze`              | 文字材料分析（确认用）    |
| 练习   | POST   | `/exercises/generate-from-text`   | 文字材料流式出题         |
| 练习   | POST   | `/exercises/generate`             | 按文档生成题目           |
| 练习   | GET    | `/exercises/:exerciseId`         | 练习详情                 |
| 练习   | POST   | `/exercises/:exerciseId/submit`   | 提交答案                 |
| 练习   | GET    | `/exercises`                      | 练习列表                 |

以上覆盖当前前端所有模块与接口；实现时以本文档为准，若有字段增删可与前端对齐后同步更新此文档。
